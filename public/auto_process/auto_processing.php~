<?php
date_default_timezone_set("Asia/Dhaka");

$servername = "103.219.147.21";
$username = "ocpl";
$password = "Ocpl@2017";
$dbname = "dev-bida";
// Create connection
$conn = new mysqli($servername, $username, $password, $dbname);

// Check connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Check connection
if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}
$conn->query("SET NAMES 'utf8'");
//echo "Connected successfully";

ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// best stored as array, so you can add more than one
$sql3 = "select group_concat(holiday_date) as holiday_date from govt_holiday where is_active =1";
$re = $conn->query($sql3);
$get_holiday_date = $re->fetch_assoc()['holiday_date'];
$holidays = explode(',',$get_holiday_date);

$sql = "select process_type_id,desk_from,status_from, desk_to, status_to, auto_process,
        max_processing_time from process_path where auto_process=1";
$result = $conn->query($sql);

if ($result->num_rows > 0) {

    while($row = $result->fetch_assoc()) {
        $process_type_id = $row['process_type_id'];
        $max_processing_time = $row['max_processing_time'];
        $desk_id = $row['desk_from'];
        $status_from = $row['status_from'];
        $desk_to = $row['desk_to'];
        $status_to = $row['status_to'];
        $date = new DateTime(); //this returns the current date time
        $current_date = $date->format('Y-m-d-H-i-s');

        $sql6="select process_list.id as process_id, tracking_no,desk_id,process_type_id, process_list.updated_at,
                process_type.name as process_name from process_list 
                left join process_type on process_list.process_type_id = process_type.id 
                where process_type_id='$process_type_id' and status_id = '$status_from' and desk_id='$desk_id' ";
        $process_list_data1 = $conn->query($sql6);


        if ($process_list_data1->num_rows > 0) {
            //update desk,status when run cron
            $sql7 = "INSERT INTO auto_processing 
                (from_desk, from_status, process_type_id,auto_process, created_at,updated_at)
                VALUES ('$desk_id', '$status_from','$process_type_id',1,'$current_date', '$current_date')";
            $conn->query($sql7);
            $last_auto_processing_id = $conn->insert_id;

            while($row6 = $process_list_data1->fetch_assoc()) {
                $exit_holiday = holidayAndOffDay($row6['updated_at'], $holidays);
                if($exit_holiday == $max_processing_time){
                    $tracking_no = $row6['tracking_no'];
                    $process_id = $row6['process_id'];
//                6. Set current_desk = next desk, current_status = next_status, Remarks = "Automatically processed", Updated_by = "***".
                    $sql8 = "UPDATE process_list SET desk_id='$desk_to', status_id='$status_to', process_desc='Automatically processed', updated_by='1',on_behalf_of_user='1'  WHERE id=$process_id";
                    $conn->query($sql8);
                    $sql9 = "UPDATE auto_processing SET auto_process='2' WHERE id=$last_auto_processing_id";
                    $conn->query($sql9);

                    echo "Auto Process Successfully".'<br>';
                }

            }
        }else{
            echo "Data not found to auto process".'<br>';
        }
    }
}else{
    echo '';
}
$result->close();

function holidayAndOffDay($updated_date, $holidays){

    $newDate = date("Y-m-d", strtotime($updated_date));
    $start = new DateTime($newDate );
    $today_date = date('Y-m-d');
    $end = new DateTime($today_date);
    // otherwise the  end date is excluded (bug?)
//    $end->modify('+1 day');
    $interval = $end->diff($start);

    // total days
    $days = $interval->days;
    // create an iterateable period of date (P1D equates to 1 day)
    $period = new DatePeriod($start, new DateInterval('P1D'), $end);

//    $holidays = array('2018-07-17', '2018-07-19');
    foreach($period as $dt) {
        $curr = $dt->format('D');
        // substract if Saturday or Sunday
        if ($curr == 'Fri' || $curr == 'Sat') {
            $days--;
        }
        // (optional) for the updated question
        elseif (in_array($dt->format('Y-m-d'), $holidays)) {
            $days--;
        }
    }
    return $days;

}



?>
